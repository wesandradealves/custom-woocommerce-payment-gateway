!function(t,e,o){console.log("[BDM Checkout] Initializing...");const n={config:{checkInterval:15e3,countdown:5},state:{cotation:null,settings:null,products:null,intervalId:null},getCotation:async function(){const{asset:t,endpoint_quotation:e}=this.state.settings;try{const o=`${e}/${t}`;if(!o)return console.warn("[BDM Checkout] Endpoint Quotation is not defined."),this.config.fallbackCotation;const n=await fetch(o),a=await n.json();return a?.BRL}catch(t){return console.warn("[BDM Checkout] Error fetching cotation:",t),this.config.fallbackCotation}},init:async function(){this.state.settings=bdm_digital_payment_gateway_checkout_data?.settings,this.state.products=bdm_digital_payment_gateway_checkout_data?.products,this.state.settings&&this.state.products?(this.state.cotation=await this.getCotation(),this.clearLocalStorage(),this.bindEvents()):console.error("[BDM Checkout] Missing configuration data.")},clearLocalStorage:function(){sessionStorage.removeItem("order_id"),sessionStorage.removeItem("billingcode")},bindEvents:function(){t("#bdm-checkout-button").on("click",(async t=>{t.preventDefault(),await this.handleCheckout()})),t("#bdm-copycode").on("click",(t=>{t.preventDefault(),this.copyPaymentCode()}))},handleCheckout:async function(){const t=this.calculateTotalPrice(this.state.products),e=parseFloat((t/this.state.cotation).toFixed(2));a.updateCheckoutUIBefore(t,e);try{const t=await this.createWooCommerceOrder(e),o=await this.requestBillingCode(e,t.data.order_id);o?.billingCode?this.updateUIAfterBillingCode(o):r.error("Failed to generate payment code.")}catch(t){console.error("[BDM Checkout] Error during checkout:",t),r.error("Error processing checkout.")}},calculateTotalPrice:function(t){const e=this.formatCart(t);return Object.values(e).reduce(((t,e)=>t+e.price),0)},formatCart:function(t){const e=t=>{let e=(t=>{const e=o.createElement("textarea");return e.innerHTML=t,e.value})(t).replace(/<[^>]*>/g,"").trim();e=e.replace(",",".");const n=e.match(/[\d.]+/g);return n?parseFloat(n.join("")):0};return Object.entries(t).reduce(((t,[o,n])=>(t[o]={...n,price:e(n.price)},t)),{})},requestBillingCode:async function(t,e){const{endpoint:o,api_key:n,partner_email:a,asset:r}=this.state.settings;return(await fetch(`${o}ecommerce-partner/billing-code`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify({partnerEmail:a,amount:t,toAsset:r,attachment:`Pedido #${e}`,fromAsset:r})})).json()},updateUIAfterBillingCode:function(e){a.hideLoading(),t("#step-1, #step-2").toggleClass("d-flex d-none"),a.setHTML("#billingcode",e.billingCode),t("#qrcode").html(`<img src="${e.qrCode}" alt="QR Code" />`),sessionStorage.setItem("billingcode",e.billingCode)},createWooCommerceOrder:function(e){const{partner_email:o}=this.state.settings,n=bdm_digital_payment_gateway_checkout_data&&bdm_digital_payment_gateway_checkout_data.nonce;return n?(console.log("[BDM Checkout] Enviando nonce:",n),new Promise(((a,s)=>{t.post(bdm_digital_payment_gatewayAjax.ajax_url,{action:"bdm_digital_payment_gateway_create_order",billing_code:sessionStorage.getItem("billingcode"),amount:e,partner_email:o,products:JSON.stringify(this.state.products),nonce:n}).done((t=>{if(console.log("[BDM Checkout] Resposta AJAX:",t),t.success)sessionStorage.setItem("order_id",t.data.order_id),this.startCountdown(this.config.countdown),this.startStatusInterval(),a(t);else{const e=t.message||"Erro desconhecido ao criar pedido.";console.error("Error creating WooCommerce order:",e),r.error(e),s(e)}})).fail((t=>{console.error("Error creating WooCommerce order:",t),r.error("Erro de comunicação com o servidor."),s(t)}))}))):(console.error("[BDM Checkout] Nonce ausente. Não é possível criar o pedido."),r.error("Erro de segurança: nonce ausente. Recarregue a página."),Promise.reject("Nonce ausente"))},startCountdown:function(t){let e=60*t;const n=o.getElementById("counter"),a=setInterval((()=>{const t=Math.floor(e/60),o=e%60;n.innerHTML=`${t}:${o<10?"0":""}${o}`,e--,e<0&&(clearInterval(a),this.onCountdownFinished())}),1e3)},onCountdownFinished:function(){r.warning("Payment time expired!"),t("#step-2, #step-3").addClass("d-none"),t("#step-1").removeClass("d-none"),this.clearLocalStorage()},startStatusInterval:function(){this.state.intervalId&&clearInterval(this.state.intervalId),this.state.intervalId=setInterval(this.checkPaymentStatus.bind(this),this.config.checkInterval)},checkPaymentStatus:async function(){const{endpoint:t,api_key:e,partner_email:o}=this.state.settings,n=sessionStorage.getItem("billingcode");try{const a=await fetch(`${t}ecommerce-partner/clients/billingcode-status/${o}/${n}`,{method:"GET",headers:{"x-api-key":e}}),s=await a.json();"COMPLETED"===s?.status&&(clearInterval(this.state.intervalId),r.success("Payment confirmed!"),this.updateOrderStatus(sessionStorage.getItem("order_id"),s.status),setTimeout((()=>{location.reload()}),5e3))}catch(t){console.warn("[BDM Checkout] Error checking payment status:",t)}},updateOrderStatus:async function(t,e){try{await fetch("/wp-json/bdm_digital_payment_gateway/v1/update-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:t,status:e.toLowerCase(),consumer_key:this.state.settings.consumer_key,consumer_secret:this.state.settings.consumer_secret})})}catch(t){console.error("[BDM Checkout] Error updating order:",t)}},copyPaymentCode:function(){const e=t("#billingcode").text();if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(e).then((()=>r.success("Código copiado com sucesso!"))).catch((t=>{r.error("Erro ao copiar o código."),console.error(t)}));else{const t=o.createElement("input");t.value=e,o.body.appendChild(t),t.select();try{o.execCommand("copy"),r.success("Código copiado com sucesso!")}catch(t){r.error("Erro ao copiar o código."),console.error(t)}o.body.removeChild(t)}}},a={showLoading:()=>t(".loading").removeClass("d-none").addClass("d-flex"),hideLoading:()=>t(".loading").removeClass("d-flex").addClass("d-none"),setHTML:(e,o)=>t(e).html(o),updateCheckoutUIBefore:(t,e)=>{a.setHTML(".amount-bdm",e),a.setHTML(".amount",t),a.setHTML(".cotation",n.state.cotation),a.showLoading()}},r={success:e=>t.toast({heading:"Success",text:e,icon:"success",hideAfter:4e3}),error:e=>t.toast({heading:"Error",text:e,icon:"error",hideAfter:5e3}),warning:e=>t.toast({heading:"Warning",text:e,icon:"warning",hideAfter:5e3})};t(o).ready((()=>n.init()))}(jQuery,window,document);