!function(e,t,o){const n={config:{checkInterval:15e3,countdown:5},state:{cotation:null,settings:null,products:null,intervalId:null},getCotation:async function(){const{asset:e,endpoint_quotation:t}=this.state.settings;try{const o=`${t}/${e}`;if(!o)return console.warn("[BDM Checkout] Endpoint Quotation is not defined."),this.config.fallbackCotation;const n=await fetch(o),r=await n.json();return r?.BRL}catch(e){return console.warn("[BDM Checkout] Error fetching cotation:",e),this.config.fallbackCotation}},init:async function(){this.state.settings=bdmdipag_checkout_data?.settings,this.state.products=bdmdipag_checkout_data?.products,this.state.settings&&this.state.products?(this.state.cotation=await this.getCotation(),this.clearLocalStorage(),this.bindEvents()):console.error("[BDM Checkout] Missing configuration data.")},clearLocalStorage:function(){sessionStorage.removeItem("order_id"),sessionStorage.removeItem("billingcode")},bindEvents:function(){e("#bdm-checkout-button").on("click",(async e=>{e.preventDefault(),await this.handleCheckout()})),e("#bdm-copycode").on("click",(e=>{e.preventDefault(),this.copyPaymentCode()}))},handleCheckout:async function(){const e=this.calculateTotalPrice(this.state.products),t=parseFloat((e/this.state.cotation).toFixed(2));r.updateCheckoutUIBefore(e,t);try{const e=await this.createWooCommerceOrder(t),o=await this.requestBillingCode(t,e.data.order_id);o?.billingCode?this.updateUIAfterBillingCode(o):a.error("Failed to generate payment code.")}catch(e){console.error("[BDM Checkout] Error during checkout:",e),a.error("Error processing checkout.")}},calculateTotalPrice:function(e){const t=this.formatCart(e);return Object.values(t).reduce(((e,t)=>e+t.price),0)},formatCart:function(e){const t=e=>{let t=(e=>{const t=o.createElement("textarea");return t.innerHTML=e,t.value})(e).replace(/<[^>]*>/g,"").trim();t=t.replace(",",".");const n=t.match(/[\d.]+/g);return n?parseFloat(n.join("")):0};return Object.entries(e).reduce(((e,[o,n])=>(e[o]={...n,price:t(n.price)},e)),{})},requestBillingCode:async function(e,t){const{endpoint:o,api_key:n,partner_email:r,asset:a}=this.state.settings;return(await fetch(`${o}ecommerce-partner/billing-code`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify({partnerEmail:r,amount:e,toAsset:a,attachment:`Pedido #${t}`,fromAsset:a})})).json()},updateUIAfterBillingCode:function(t){r.hideLoading(),e("#step-1, #step-2").toggleClass("d-flex d-none"),r.setHTML("#billingcode",t.billingCode),e("#qrcode").html(`<img src="${t.qrCode}" alt="QR Code" />`),sessionStorage.setItem("billingcode",t.billingCode)},createWooCommerceOrder:function(t){const{partner_email:o}=this.state.settings,n=bdmdipag_checkout_data&&bdmdipag_checkout_data.nonce;return n?(console.log("[BDM Checkout] Enviando nonce:",n),new Promise(((r,s)=>{e.post(bdmdipagAjax.ajax_url,{action:"bdmdipag_create_order",billing_code:sessionStorage.getItem("billingcode"),amount:t,partner_email:o,products:JSON.stringify(this.state.products),nonce:n}).done((e=>{if(console.log("[BDM Checkout] Resposta AJAX:",e),e.success)sessionStorage.setItem("order_id",e.data.order_id),this.startCountdown(this.config.countdown),this.startStatusInterval(),r(e);else{const t=e.message||"Erro desconhecido ao criar pedido.";console.error("Error creating WooCommerce order:",t),a.error(t),s(t)}})).fail((e=>{console.error("Error creating WooCommerce order:",e),a.error("Erro de comunicação com o servidor."),s(e)}))}))):(console.error("[BDM Checkout] Nonce ausente. Não é possível criar o pedido."),a.error("Erro de segurança: nonce ausente. Recarregue a página."),Promise.reject("Nonce ausente"))},startCountdown:function(e){let t=60*e;const n=o.getElementById("counter"),r=setInterval((()=>{const e=Math.floor(t/60),o=t%60;n.innerHTML=`${e}:${o<10?"0":""}${o}`,t--,t<0&&(clearInterval(r),this.onCountdownFinished())}),1e3)},onCountdownFinished:function(){a.warning("Payment time expired!"),e("#step-2, #step-3").addClass("d-none"),e("#step-1").removeClass("d-none"),this.clearLocalStorage()},startStatusInterval:function(){this.state.intervalId&&clearInterval(this.state.intervalId),this.state.intervalId=setInterval(this.checkPaymentStatus.bind(this),this.config.checkInterval)},checkPaymentStatus:async function(){const{endpoint:e,api_key:t,partner_email:o}=this.state.settings,n=sessionStorage.getItem("billingcode");try{const r=await fetch(`${e}ecommerce-partner/clients/billingcode-status/${o}/${n}`,{method:"GET",headers:{"x-api-key":t}}),s=await r.json();"COMPLETED"===s?.status&&(clearInterval(this.state.intervalId),a.success("Payment confirmed!"),this.updateOrderStatus(sessionStorage.getItem("order_id"),s.status),setTimeout((()=>{location.reload()}),5e3))}catch(e){console.warn("[BDM Checkout] Error checking payment status:",e)}},updateOrderStatus:async function(e,t){try{await fetch("/wp-json/bdmdipag/v1/update-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:e,status:t.toLowerCase(),consumer_key:this.state.settings.consumer_key,consumer_secret:this.state.settings.consumer_secret})})}catch(e){console.error("[BDM Checkout] Error updating order:",e)}},copyPaymentCode:function(){const t=e("#billingcode").text();if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(t).then((()=>a.success("Código copiado com sucesso!"))).catch((e=>{a.error("Erro ao copiar o código."),console.error(e)}));else{const e=o.createElement("input");e.value=t,o.body.appendChild(e),e.select();try{o.execCommand("copy"),a.success("Código copiado com sucesso!")}catch(e){a.error("Erro ao copiar o código."),console.error(e)}o.body.removeChild(e)}}},r={showLoading:()=>e(".loading").removeClass("d-none").addClass("d-flex"),hideLoading:()=>e(".loading").removeClass("d-flex").addClass("d-none"),setHTML:(t,o)=>e(t).html(o),updateCheckoutUIBefore:(e,t)=>{r.setHTML(".amount-bdm",t),r.setHTML(".amount",e),r.setHTML(".cotation",n.state.cotation),r.showLoading()}},a={success:t=>e.toast({heading:"Success",text:t,icon:"success",hideAfter:4e3}),error:t=>e.toast({heading:"Error",text:t,icon:"error",hideAfter:5e3}),warning:t=>e.toast({heading:"Warning",text:t,icon:"warning",hideAfter:5e3})};e(o).ready((()=>n.init()))}(jQuery,window,document);